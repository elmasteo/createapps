<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cargue Masivo de Apps</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="icon" href="https://docs.nuvei.com/wp-content/themes/manual-child/img/favicons/cropped-favicon-nuvei-32x32.png" sizes="32x32">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h2>Cargue Masivo de Apps desde Excel</h2>
   <div class="tab-wrapper">
    <ul>
      <li><a class="index" href="index.html">Single</a></li>
      <li><a class="massive" href="carguemasivo.html">Massive</a></li>
    </ul>
  </div>
  <a href="formatomasivo.xlsx" download class="download-btn">Download format</a>
  <input type="file" id="excelFile" accept=".xlsx, .xls" />
  <button id="sendData">Enviar Datos al Backend</button>

  <div id="log" class="log"></div>

  <script>
  const path = window.location.pathname.replace('/', '').replace('.html', '') || 'index';

  document.querySelectorAll('ul li a').forEach(link => {
    if (link.classList.contains(path)) {
      link.classList.add('active');
    }
  });
</script>

  <script>

    async function init() {
  const clave = await new Promise(resolve => {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100vw";
    overlay.style.height = "100vh";
    overlay.style.background = "rgba(0,0,0,0.8)";
    overlay.style.display = "flex";
    overlay.style.flexDirection = "column";
    overlay.style.justifyContent = "center";
    overlay.style.alignItems = "center";
    overlay.style.zIndex = 9999;

    const input = document.createElement("input");
    input.type = "password";
    input.placeholder = "ðŸ”’ Ingresa tu clave";
    input.style.padding = "10px";
    input.style.fontSize = "16px";
    input.style.borderRadius = "5px";
    input.style.border = "1px solid #ccc";
    input.style.marginBottom = "10px";
    input.style.width = "250px"; // ancho fijo
    input.style.maxWidth = "80%"; // no mÃ¡s del 80% en pantallas pequeÃ±as
    input.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)"; // sombra sutil
    input.style.background = "#fff";

    const btn = document.createElement("button");
    btn.textContent = "Acceder";
    btn.style.padding = "10px 20px";
    btn.style.fontSize = "16px";
    btn.style.border = "none";
    btn.style.borderRadius = "5px";
    btn.style.cursor = "pointer";
    btn.style.background = "#4CAF50";
    btn.style.color = "#fff";

      btn.onclick = () => {
        const val = input.value;
        document.body.removeChild(overlay);
        resolve(val);
      };

      overlay.appendChild(input);
      overlay.appendChild(btn);
      document.body.appendChild(overlay);
    });

  const res = await fetch('/.netlify/functions/validarClave', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ clave })
  });

  const { autorizado } = await res.json();

  if (!autorizado) {
    alert("Clave incorrecta. Acceso denegado.");
    document.body.innerHTML = "<h2 style='text-align:center; margin-top:20%'>ðŸš« Acceso no autorizado</h2>";
    return;
  }

}

init();

    let excelData = [];

    document.getElementById("excelFile").addEventListener("change", handleFile);

    function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        excelData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        logMessage(`Archivo cargado: ${file.name} - ${excelData.length} registros`, "ok");
      };
      reader.readAsArrayBuffer(file);
    }

    document.getElementById("sendData").addEventListener("click", async () => {
      if (excelData.length === 0) {
        logMessage("No hay datos cargados desde Excel", "error");
        return;
      }

      for (let i = 0; i < excelData.length; i++) {
        const row = excelData[i];
        try {
          const res = await fetch("/.netlify/functions/crearAppsv2", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(row)
          });

          if (!res.ok) throw new Error(await res.text());

          const json = await res.json();
          logMessage(`Fila ${i + 1}: Enviado correctamente - AppCode: ${json.appCode || 'N/A'}`, "ok");
        } catch (err) {
          logMessage(`Fila ${i + 1}: Error - ${err.message}`, "error");
        }
      }
    });

    function logMessage(msg, type) {
      const logDiv = document.getElementById("log");
      const p = document.createElement("p");
      p.className = type;
      p.textContent = msg;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  </script>

</body>
</html>
