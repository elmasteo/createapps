<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Apps</title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    .app-container, .proc-container { border:1px solid #ccc; padding:10px; margin-bottom:15px; }
    .log { background:#f5f5f5; padding:10px; white-space:pre-wrap; height:300px; overflow-y:auto; border:1px solid #ccc; }
    label { display:block; margin-bottom:5px; }
  </style>
</head>
<body>
  <h1>Generador de Apps</h1>
  <div id="apps"></div>
  <button onclick="addApp()">+ Agregar App</button>
  <button onclick="enviarApps()">Enviar Todo</button>
  <h2>Logs</h2>
  <div id="log" class="log"></div>

  <script>

    let appIndex = 0;
    function addApp() {
      const c = document.createElement('div');
      c.className = 'app-container';
      c.innerHTML = `
        <h3>App ${appIndex+1}</h3>
        <label>C√≥digo: <input name="code"/></label>
        <label>Owner: <input name="owner_name"/></label>
        <label>Callback URL: <input name="callback_url"/></label>
        <label>Moneda: <input name="currency" value="COP"/></label>
        <label>Tipo integraci√≥n:
          <select name="tipo_integracion">
            <option value="SERVER/CLIENT">SERVER/CLIENT</option>
            <option value="PCI">PCI</option>
            <option value="LTP">LTP</option>
          </select>
        </label>
        <div class="procesadores"></div>
        <button type="button" onclick="addProcesador(this)">+ Procesador</button>
      `;
      document.getElementById('apps').appendChild(c);
      appIndex++;
    }

    function addProcesador(btn) {
      if (!procesadoresConfig) return;
      const pdiv = document.createElement('div');
      pdiv.className = 'proc-container';
      pdiv.innerHTML = `
        <label>Procesador:
          <select name="tipo" onchange="renderCampos(this)">
            ${Object.keys(procesadoresConfig).map(k => `<option>${k}</option>`).join('')}
          </select>
        </label>
        <div class="campos"></div>
        <button type="button" onclick="this.parentElement.remove()">Eliminar Procesador</button>
      `;
      
      // üõ† Esta es la l√≠nea corregida
      btn.closest('.app-container').querySelector('.procesadores').appendChild(pdiv);

      const select = pdiv.querySelector('[name="tipo"]');
      renderCampos(select);
    }



    function renderCampos(el) {
    const select = el.tagName === 'SELECT' ? el : el.parentElement.querySelector('[name="tipo"]');
    const proc = select.closest('.proc-container');
    const tipo = select.value;
    const spec = procesadoresConfig[tipo];
    const div = proc.querySelector('.campos');
    div.innerHTML = '';
    Object.entries(spec.campos).forEach(([field, def]) => {
      if (def.valorFijo !== undefined) {
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = field;
        inp.value = def.valorFijo;
        div.appendChild(inp);
      } else {
        const lbl = document.createElement('label');
        lbl.textContent = field;
        const inp = document.createElement('input');
        inp.name = field;
        lbl.appendChild(inp);
        div.appendChild(lbl);
      }
    });
  }


    async function enviarApps() {
      const log = document.getElementById('log');
      log.textContent = '';
      const apps = document.querySelectorAll('.app-container');
      for (const app of apps) {
        const ownerName = app.querySelector('[name="name"]')?.value || app.querySelector('[name="owner_name"]').value;

        const payload = {
          code: app.querySelector('[name="code"]').value,
          name: ownerName,
          owner_name: ownerName,
          callback_url: app.querySelector('[name="callback_url"]').value,
          currency: app.querySelector('[name="currency"]').value,
          tipo_integracion: app.querySelector('[name="tipo_integracion"]').value,
          use_ccapi_announce: true,
          http_notifications_enabled: true,
          procesadores: []
        };
        app.querySelectorAll('.proc-container').forEach(p=> {
          const tipo = p.querySelector('[name="tipo"]').value;
          const campos = {};
          p.querySelectorAll('input').forEach(i=>{
            if (i.name) campos[i.name] = i.value === 'true' ? true : (i.value === 'false' ? false : i.value);
          });
          payload.procesadores.push({
            tipo,
            carrier: procesadoresConfig[tipo].carrier,
            campos
          });
        });

        const resp = await fetch('/.netlify/functions/crearAppsv2', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        log.textContent += `App ${payload.code} ‚Üí ${JSON.stringify(data, null,2)}\n\n`;
      }
    }
  </script>
  <script>
  let procesadoresConfig = null;

  window.onload = function () {
    // Asegura que el script procesadores.js ya se carg√≥
    procesadoresConfig = window.procesadoresConfig;
    addApp(); // Puedes cargar una app por defecto al inicio si lo deseas
  };
</script>
<script src="procesadores.js"></script>


</body>
</html>
