<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Apps</title>
  <link rel="icon" href="https://docs.nuvei.com/wp-content/themes/manual-child/img/favicons/cropped-favicon-nuvei-32x32.png" sizes="32x32">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="wrapper">
    <div class="logo-wrapper">
      <img src="https://cdn.paymentez.com/img/nv/nuvei_logo.png" alt="Nuvei Logo">
    </div>

  <div class="tab-wrapper">
    <ul>
      <li><a class="index" href="index.html">Single</a></li>
      <li><a class="massive" href="carguemasivo.html">Massive</a></li>
    </ul>
  </div>

    <div class="container">
      <!-- Panel izquierdo: Formularios -->
      <div class="form-section">
        <h1>Generador de Apps</h1>
        <div id="apps"></div>
        <button onclick="addApp()">+ Agregar App</button>
        <button onclick="enviarApps()">Enviar Todo</button>
      </div>

      <!-- Panel derecho: Log -->
      <div class="log-section">
        <h2>Logs</h2>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

  <script>
  const path = window.location.pathname.replace('/', '').replace('.html', '') || 'index';

  document.querySelectorAll('ul li a').forEach(link => {
    if (link.classList.contains(path)) {
      link.classList.add('active');
    }
  });
</script>

  <script>

async function init() {
  // Paso 1: pedir clave
  const clave = await new Promise(resolve => {
    const overlay = document.createElement("div");
    overlay.style = `
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 9999;
    `;

    const input = document.createElement("input");
    input.type = "password";
    input.placeholder = "üîí Ingresa tu clave";
    input.style.cssText = `
      padding: 12px 16px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc;
      margin-bottom: 15px; width: 280px; outline: none;
    `;

    const btn = document.createElement("button");
    btn.textContent = "Acceder";
    btn.style.cssText = `
      padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white;
      border: none; border-radius: 6px; cursor: pointer;
    `;
    btn.onmouseenter = () => btn.style.backgroundColor = "#45a049";
    btn.onmouseleave = () => btn.style.backgroundColor = "#4CAF50";

    btn.onclick = () => {
      document.body.removeChild(overlay);
      resolve(input.value);
    };

    overlay.appendChild(input);
    overlay.appendChild(btn);
    document.body.appendChild(overlay);
  });

  // Paso 2: validar clave
  const res = await fetch('/.netlify/functions/validarClave', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ clave })
  });

  const { autorizado } = await res.json();

  if (!autorizado) {
    alert("Clave incorrecta. Acceso denegado.");
    document.body.innerHTML = "<h2 style='text-align:center; margin-top:20%'>üö´ Acceso no autorizado</h2>";
    return;
  }

  // Paso 3: pedir ambiente
  window.AMBIENTE = await new Promise(resolve => {
    const overlay = document.createElement("div");
    overlay.style = `
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 9999;
    `;

    const select = document.createElement("select");
    select.style.cssText = `
      padding: 12px 16px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc;
      margin-bottom: 15px; width: 280px; outline: none;
    `;
    select.innerHTML = `
      <option value="sandbox">üåê Sandbox</option>
      <option value="produccion">üöÄ Producci√≥n</option>
    `;

    const btn = document.createElement("button");
    btn.textContent = "Confirmar";
    btn.style.cssText = `
      padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white;
      border: none; border-radius: 6px; cursor: pointer;
    `;
    btn.onmouseenter = () => btn.style.backgroundColor = "#0069d9";
    btn.onmouseleave = () => btn.style.backgroundColor = "#007bff";

    btn.onclick = () => {
      document.body.removeChild(overlay);
      resolve(select.value);
    };

    overlay.appendChild(select);
    overlay.appendChild(btn);
    document.body.appendChild(overlay);
  });
}


init();

let appIndex = 0;

function addApp() {
  const c = document.createElement('div');
  c.className = 'app-container';
  c.innerHTML = `
    <button class="remove-app" onclick="removeApp(this)" title="Eliminar App">√ó</button>
    <h3>App ${appIndex + 1}</h3>
    <label>C√≥digo: <input name="code" /></label>
    <label>Owner: <input name="owner_name" /></label>
    <label>Callback URL: <input name="callback_url" /></label>
    <label>Moneda: <input name="currency" value="COP" /></label>
    <label>Tipo integraci√≥n:
      <select name="tipo_integracion">
        <option value="SERVER/CLIENT">SERVER/CLIENT</option>
        <option value="PCI">PCI</option>
        <option value="LTP">LTP</option>
      </select>
    </label>
    <div class="procesadores"></div>
    <button type="button" onclick="addProcesador(this)">+ Procesador</button>
  `;
  document.getElementById('apps').appendChild(c);
  appIndex++;
  updateAppHeaders();
}

function removeApp(btn) {
  btn.parentElement.remove();
  const totalApps = document.querySelectorAll('.app-container').length;
  if (totalApps === 0) {
    appIndex = 0;
  }
  updateAppHeaders();
}

function updateAppHeaders() {
  const apps = document.querySelectorAll('.app-container');
  apps.forEach((app, i) => {
    const header = app.querySelector('h3');
    if (header) header.textContent = `App ${i + 1}`;
  });
}



    function addProcesador(btn) {
      if (!procesadoresConfig) return;
      const pdiv = document.createElement('div');
      pdiv.className = 'proc-container';
      pdiv.innerHTML = `
        <label>Procesador:
          <select name="tipo" onchange="renderCampos(this)">
            ${Object.keys(procesadoresConfig).map(k => `<option>${k}</option>`).join('')}
          </select>
        </label>
        <div class="campos"></div>
        <button type="button" onclick="this.parentElement.remove()">Eliminar Procesador</button>
      `;
      btn.closest('.app-container').querySelector('.procesadores').appendChild(pdiv);
      const select = pdiv.querySelector('[name="tipo"]');
      renderCampos(select);
    }

    function renderCampos(el) {
      const select = el.tagName === 'SELECT' ? el : el.parentElement.querySelector('[name="tipo"]');
      const proc = select.closest('.proc-container');
      const tipo = select.value;
      const spec = procesadoresConfig[tipo];
      const div = proc.querySelector('.campos');
      div.innerHTML = '';
      Object.entries(spec.campos).forEach(([field, def]) => {
        const label = def.label || field;

        if (def.valorFijo !== undefined) {
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = field;
          inp.value = def.valorFijo;
          div.appendChild(inp);
        } else {
          const lbl = document.createElement('label');
          lbl.textContent = label;
          const inp = document.createElement('input');
          inp.name = field;
          lbl.appendChild(inp);
          div.appendChild(lbl);
        }
      });

    }

    async function enviarApps() {
      const log = document.getElementById('log');
      log.textContent = '';
      const apps = document.querySelectorAll('.app-container');
      for (const app of apps) {
        const ownerName = app.querySelector('[name="name"]')?.value || app.querySelector('[name="owner_name"]').value;

        const payload = {
          code: app.querySelector('[name="code"]').value,
          name: ownerName,
          owner_name: ownerName,
          callback_url: app.querySelector('[name="callback_url"]').value,
          currency: app.querySelector('[name="currency"]').value,
          tipo_integracion: app.querySelector('[name="tipo_integracion"]').value,
          use_ccapi_announce: true,
          http_notifications_enabled: true,
          procesadores: []
        };

        app.querySelectorAll('.proc-container').forEach(p => {
        const tipo = p.querySelector('[name="tipo"]').value;
        const campos = {};

        // Campos visibles del frontend
        p.querySelectorAll('input').forEach(i => {
          if (i.name) campos[i.name] = i.value === 'true' ? true : (i.value === 'false' ? false : i.value);
        });

        // Agregar campos fijos si existen
        const fijos = procesadoresConfig[tipo].fijos || {};
        for (const [k, v] of Object.entries(fijos)) {
          campos[k] = v;
        }

        // ‚úÖ Incluir carrier_noccapi si es requerido
        if (procesadoresConfig[tipo].usa_noccapi) {
          campos.carrier_noccapi = procesadoresConfig[tipo].carrier;
        }

        payload.procesadores.push({
          tipo,
          carrier: procesadoresConfig[tipo].carrier,
          campos
        });
      });

        const resp = await fetch('/.netlify/functions/crearAppsv2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...payload, ambiente: window.AMBIENTE }) // Enviamos el ambiente
      });


        const data = await resp.json();
        log.innerHTML += `<div><strong>App ${payload.code}</strong> ‚Üí <pre>${JSON.stringify(data, null, 2)}</pre></div><hr>`;
      }
    }

    let procesadoresConfig = null;

    window.onload = function () {
      procesadoresConfig = window.procesadoresConfig;
      addApp();
    };
  </script>
  <script src="procesadores.js"></script>
</body>
</html>
