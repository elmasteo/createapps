<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Apps</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .app-container, .proc-container { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; }
    .log { background: #f5f5f5; padding: 10px; white-space: pre-wrap; height: 300px; overflow-y: auto; border: 1px solid #ccc; }
    .field-pair { display: flex; gap: 10px; margin-bottom: 5px; }
    .field-pair input { width: 45%; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Generador de Apps</h1>

  <div id="apps"></div>
  <button onclick="addApp()">Agregar App</button>
  <button onclick="enviarApps()">Enviar Todo</button>

  <h2>Logs</h2>
  <div id="log" class="log"></div>

  <script>
    let appIndex = 0;

    function addApp() {
      const container = document.createElement('div');
      container.className = 'app-container';
      container.innerHTML = `
        <h3>App ${appIndex + 1}</h3>
        Código: <input name="code"><br>
        Owner: <input name="owner_name"><br>
        Callback URL: <input name="callback_url"><br>
        Moneda: <input name="currency" value="COP"><br>
        Tipo de integración: 
        <select name="tipo_integracion">
          <option value="SERVER/CLIENT">SERVER/CLIENT</option>
          <option value="PCI">PCI</option>
          <option value="LTP">LTP</option>
        </select><br><br>
        <div class="procesadores"></div>
        <button type="button" onclick="addProcesador(this)">+ Procesador</button>
      `;
      document.getElementById('apps').appendChild(container);
      appIndex++;
    }

    function addProcesador(btn) {
      const contenedor = btn.previousElementSibling;
      const proc = document.createElement('div');
      proc.className = 'proc-container';
      proc.innerHTML = `
        Tipo procesador: <input name="tipo"><br>
        Carrier ID: <input name="carrier" type="number"><br>
        <div class="campos"></div>
        <button type="button" onclick="addCampo(this)">+ Campo</button>
        <button type="button" onclick="this.parentElement.remove()">Eliminar Procesador</button>
      `;
      contenedor.appendChild(proc);
    }

    function addCampo(btn) {
      const camposDiv = btn.previousElementSibling;
      const pair = document.createElement('div');
      pair.className = 'field-pair';
      pair.innerHTML = `
        <input placeholder="Nombre del campo">
        <input placeholder="Valor del campo">
        <button onclick="this.parentElement.remove()">❌</button>
      `;
      camposDiv.appendChild(pair);
    }

    async function enviarApps() {
      const apps = document.querySelectorAll('.app-container');
      const log = document.getElementById('log');
      log.textContent = 'Procesando...\n';

      for (const app of apps) {
        const procesadores = [];
        const procContainers = app.querySelectorAll('.proc-container');
        for (const proc of procContainers) {
          const tipo = proc.querySelector('[name="tipo"]').value;
          const carrier = parseInt(proc.querySelector('[name="carrier"]').value);
          const campos = {};
          proc.querySelectorAll('.field-pair').forEach(pair => {
            const key = pair.children[0].value.trim();
            const value = pair.children[1].value.trim();
            if (key) {
              if (value.toLowerCase() === "true") {
                campos[key] = true;
              } else if (value.toLowerCase() === "false") {
                campos[key] = false;
              } else if (!isNaN(value) && !/^0[0-9]/.test(value)) {
                campos[key] = Number(value);
              } else {
                campos[key] = value; // mantener como string si empieza con 0 o no es número
              }
            }

          });
          const config = window.procesadoresConfig?.[tipo] || {};
          const fijos = config.fijos || {};

          procesadores.push({ tipo, carrier, valores: campos, fijos });

        }

        const payload = {
          code: app.querySelector('[name="code"]').value,
          name: app.querySelector('[name="owner_name"]').value,
          owner_name: app.querySelector('[name="owner_name"]').value,
          callback_url: app.querySelector('[name="callback_url"]').value,
          currency: app.querySelector('[name="currency"]').value,
          tipo_integracion: app.querySelector('[name="tipo_integracion"]').value,
          use_ccapi_announce: true,
          http_notifications_enabled: true,
          procesadores
        };

        try {
          const payloadEnriquecido = {
            ...payload,
            procesadores: payload.procesadores.map(p => {
              const config = window.procesadoresConfig?.[p.tipo] || {};
              const fijos = config.fijos || {};
              const camposCombinados = { ...fijos, ...p.valores };

              // Añadir campos derivados según el tipo
              if (p.tipo === 'RB') {
                camposCombinados['merchant_id'] = p.valores['rb_idAdquiriente'];
                camposCombinados['terminal_id'] = p.valores['rb_idTerminal'];
              }

              if (p.tipo === 'CBCO') {
                camposCombinados['cb_commerce_id'] = p.valores['cb_commerce_id'];
                camposCombinados['merchant_id'] = p.valores['cb_commerce_id'];
                camposCombinados['terminal_id'] = p.valores['cb_terminal_code'];
              }

              return {
                tipo: p.tipo,
                carrier: p.carrier,
                campos: camposCombinados
              };
            })
          };

          const res = await fetch('/.netlify/functions/createAppsv2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payloadEnriquecido)
          });

          const data = await res.json();
          log.textContent += `Resultado para "${payload.code}":\n${JSON.stringify(data, null, 2)}\n\n`;

        } catch (e) {
          log.textContent += `Error procesando "${payload.code}": ${e.message}\n`;
        }

      }
    }
  </script>
</body>
</html>
